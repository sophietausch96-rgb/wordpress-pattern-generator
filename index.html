<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WP Pattern Generator</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div class="container">
    <!-- LINKS: WP Playground (neue Seite) -->
    <iframe
      id="wpFrame"
      class="playground"
      src="https://playground.wordpress.net/?mode=seamless&blueprint-url=./blueprint.json&start_url=%2Fwp-admin%2Fpost-new.php%3Fpost_type%3Dpage"
      title="WordPress Playground"></iframe>

    <!-- RECHTS: Bot -->
    <aside class="chatbox">
      <div class="tabs">
        <button class="tab active" data-tab="chat">Chat</button>
        <button class="tab" data-tab="settings">Einstellungen</button>
      </div>

      <div class="tabcontent active" id="tab-chat">
        <div class="model-row">
          <span class="model-info" id="modelInfo">Modell: –</span>
          <span class="spinner" id="spinner" aria-hidden="true"></span>
        </div>

        <div id="messages" class="messages"></div>

        <form id="chatForm" class="input-row">
          <input id="chatInput" placeholder="Beschreibe dein Pattern …" />
          <button id="sendBtn" type="submit">Senden</button>
        </form>
      </div>

      <div class="tabcontent" id="tab-settings">
        <h3>API-Key</h3>
        <input id="apiKeyInput" type="password" placeholder="OpenRouter API Key (sk-or-…)" />
        <button id="saveKeyBtn" type="button">Speichern</button>
      </div>
    </aside>
  </div>

<script>
const els = {
  frame: document.getElementById('wpFrame'),
  messages: document.getElementById('messages'),
  form: document.getElementById('chatForm'),
  input: document.getElementById('chatInput'),
  sendBtn: document.getElementById('sendBtn'),
  modelInfo: document.getElementById('modelInfo'),
  spinner: document.getElementById('spinner'),
  apiKeyInput: document.getElementById('apiKeyInput'),
  saveBtn: document.getElementById('saveKeyBtn')
};

try { els.apiKeyInput.value = localStorage.getItem("openrouter_key") || ""; } catch(e){}

els.saveBtn.addEventListener('click', () => {
  localStorage.setItem("openrouter_key", els.apiKeyInput.value.trim());
  alert("API-Key gespeichert!");
});

function addMsg(role, html){
  const div = document.createElement("div");
  div.className = "msg " + role;
  div.innerHTML = html;
  els.messages.appendChild(div);
  els.messages.scrollTop = els.messages.scrollHeight;
}

function setLoading(state){
  els.sendBtn.disabled = !!state;
  els.spinner.classList.toggle("on", !!state);
}

async function callLLM(prompt){
  const key = localStorage.getItem("openrouter_key") || "";
  if(!key) throw new Error("API-Key fehlt");
  const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
    method:"POST",
    headers:{
      "Authorization":"Bearer "+key,
      "Content-Type":"application/json"
    },
    body: JSON.stringify({
      model: "mistralai/mistral-7b-instruct:free",
      messages:[
        {role:"system", content:"Du gibst ausschließlich gültiges Gutenberg-HTML zurück. Keine Erklärungen."},
        {role:"user", content:prompt}
      ]
    })
  });
  const data = await res.json();
  return (data.choices?.[0]?.message?.content || "").replace(/```/g,"").trim();
}

function sendToWP(html){
  els.frame.contentWindow.postMessage({
    type:"AI_PATTERNS_CREATE",
    payload:{ title:"AI Pattern", content: html }
  }, "*");
}

els.form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const userText = els.input.value.trim();
  if(!userText) return;
  addMsg("user", "<b>Du:</b> "+userText);
  els.input.value = "";
  setLoading(true);
  try {
    const html = await callLLM("Erzeuge ein modernes Gutenberg-Pattern: "+userText);
    addMsg("bot", "<b>Bot:</b><pre class='code'>"+html+"</pre>");
    sendToWP(html);
    addMsg("info", "✅'.");
  } catch(err){
    addMsg("error", "❌ "+err.message);
  } finally {
    setLoading(false);
  }
});
</script>
</body>
</html>
