<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WP Playground + Bot mit Tabs & Auto-Patterns</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <!-- LINKS -->
    <iframe
      class="playground"
      id="wpFrame"
      src="https://playground.wordpress.net/?mode=seamless&blueprint-url=./blueprint.json"
      title="WordPress Playground">
    </iframe>

    <!-- RECHTS -->
    <aside class="chatbox">
      <div class="tabs">
        <button class="tab active" data-tab="chat">üí¨ Chat</button>
        <button class="tab" data-tab="settings">‚öôÔ∏è Einstellungen</button>
      </div>

      <!-- CHAT -->
      <div class="tabcontent active" id="tab-chat">
        <div class="model-info" id="modelInfo">Modell: ‚Äì</div>
        <div id="messages" class="messages"></div>
        <form id="chatForm" class="input-row" autocomplete="off">
          <input id="chatInput" placeholder="Beschreibe ein Pattern ‚Ä¶ (nur Core-Bl√∂cke)" />
          <button id="sendBtn" type="submit">Senden</button>
        </form>
      </div>

      <!-- EINSTELLUNGEN -->
      <div class="tabcontent" id="tab-settings">
        <h3>API-Key speichern</h3>
        <input id="apiKeyInput" type="password" placeholder="OpenRouter API Key (sk-or-‚Ä¶)" />
        <button id="saveKeyBtn" type="button">Speichern</button>
        <p class="hint">Der API-Key wird nur lokal im Browser (localStorage) gespeichert.</p>
      </div>
    </aside>
  </div>

  <script>
  // ---------- Tabs ----------
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tabcontent').forEach(tc=>tc.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-'+btn.dataset.tab).classList.add('active');
    });
  });

  // ---------- UI refs ----------
  const els = {
    keyInput: document.getElementById('apiKeyInput'),
    saveBtn: document.getElementById('saveKeyBtn'),
    form: document.getElementById('chatForm'),
    input: document.getElementById('chatInput'),
    sendBtn: document.getElementById('sendBtn'),
    messages: document.getElementById('messages'),
    modelInfo: document.getElementById('modelInfo'),
    frame: document.getElementById('wpFrame')
  };

  try { els.keyInput.value = localStorage.getItem("openrouter_key") || ""; } catch(e) {}

  els.saveBtn.addEventListener('click', () => {
    const val = (els.keyInput.value || "").trim();
    if(!val){ alert("Bitte API-Key eintragen (sk-or-‚Ä¶)"); return; }
    try { localStorage.setItem("openrouter_key", val); alert("API-Key gespeichert!"); }
    catch(e){ alert("Speichern fehlgeschlagen."); }
  });

  function addMsg(role, html){
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + role;
    wrap.innerHTML = html;
    els.messages.appendChild(wrap);
    els.messages.scrollTop = els.messages.scrollHeight;
  }

  // ---------- Modelle ----------
  const FREE_MODELS = [
    "deepseek/deepseek-chat-v3-0324:free",
    "deepseek/deepseek-r1:free",
    "mistralai/mistral-7b-instruct:free"
  ];

  const SYSTEM_PROMPT = "Du erzeugst AUSSCHLIESSLICH g√ºltiges Gutenberg-Block-HTML (serialized blocks). " +
    "Keine Erkl√§rungen, kein Markdown, keine Codefences. Nur Core-Bl√∂cke.";

  function sanitize(text){
    return (text||"").replace(/```(?:html)?/gi,"").trim();
  }

  function ensureGutenberg(html){
    const cleaned = sanitize(html);
    if (cleaned.includes("<!-- wp:")) return cleaned;
    return `<!-- wp:paragraph --><p>${cleaned||'Leere Antwort'}</p><!-- /wp:paragraph -->`;
  }

  async function callOpenRouterOnce(model, prompt){
    const key = (localStorage.getItem('openrouter_key')||'').trim();
    if(!key) throw new Error("API-Key fehlt");
    const res = await fetch("https://openrouter.ai/api/v1/chat/completions",{
      method:"POST",
      headers:{
        "Authorization":"Bearer "+key,
        "Content-Type":"application/json",
        "X-Title":"WP Pattern Generator"
      },
      body:JSON.stringify({
        model,
        messages:[
          {role:"system",content:SYSTEM_PROMPT},
          {role:"user",content:prompt}
        ],
        temperature:0.3,
        max_tokens:1200
      })
    });
    if(!res.ok) throw new Error("OpenRouter: "+res.status);
    const data=await res.json();
    return sanitize(data.choices?.[0]?.message?.content||"");
  }

  async function callWithFallbacks(prompt){
    for(const m of FREE_MODELS){
      els.modelInfo.textContent="Modell: "+m;
      try { const out=await callOpenRouterOnce(m,prompt); if(out) return {model:m,out}; }
      catch(e){ console.warn("Fehler bei",m,e); }
    }
    throw new Error("Keine Antwort von Modellen");
  }

  // ---------- WP Playground Kommunikation ----------
  async function sendPatternToWP(html){
    return new Promise((resolve,reject)=>{
      els.frame.contentWindow.postMessage({
        type:"REST_API_REQUEST",
        path:"/wp-json/ai-patterns/v1/create",
        method:"POST",
        body:{title:"AI Pattern", content:html}
      },"*");
      resolve();
    });
  }

  // ---------- Chat Handler ----------
  els.form.addEventListener('submit',async e=>{
    e.preventDefault();
    const userText=els.input.value.trim();
    if(!userText) return;
    addMsg("user","<b>Du:</b> "+userText);
    els.input.value=""; els.sendBtn.disabled=true;
    try{
      const {model,out}=await callWithFallbacks("Erzeuge Gutenberg-Pattern: "+userText);
      const html=ensureGutenberg(out);
      addMsg("bot",`<b>Bot (${model}):</b><pre class="code">${html.replace(/</g,"&lt;")}</pre>`);
      await sendPatternToWP(html);
      addMsg("info","‚úÖ Pattern automatisch ins WordPress links importiert (Inserter ‚Üí AI Patterns).");
    }catch(err){
      addMsg("error",err.message);
    }finally{ els.sendBtn.disabled=false; }
  });
  </script>
</body>
</html>
