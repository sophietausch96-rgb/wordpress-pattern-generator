<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WP Playground + OpenRouter Bot</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <!-- WordPress Playground -->
    <iframe
      class="playground"
      src="https://playground.wordpress.net/?mode=seamless&blueprint-url=./blueprint.json"
      title="WordPress Playground">
    </iframe>

    <!-- Chatbot -->
    <aside class="chatbox">
      <h2>🤖 OpenRouter Bot (Grok 4 Fast – free)</h2>
      <div class="apikey">
        <input id="apiKeyInput" placeholder="API Key (sk-or-...)" type="password"/>
        <button id="saveKeyBtn">Speichern</button>
      </div>
      <div id="messages" class="messages"></div>
      <div class="input-row">
        <input id="chatInput" placeholder="Beschreibe ein Pattern..." />
        <button id="sendBtn">Senden</button>
      </div>
    </aside>
  </div>

  <script>
  const els = {
    keyInput: document.getElementById('apiKeyInput'),
    saveBtn: document.getElementById('saveKeyBtn'),
    input: document.getElementById('chatInput'),
    sendBtn: document.getElementById('sendBtn'),
    messages: document.getElementById('messages')
  };

  // API-Key speichern/lesen
  els.keyInput.value = localStorage.getItem("openrouter_key") || "";
  els.saveBtn.onclick = () => {
    localStorage.setItem("openrouter_key", els.keyInput.value.trim());
    alert("API Key gespeichert!");
  };

  function addMsg(role, text) {
    const p = document.createElement("p");
    p.className = role;
    p.innerHTML = (role === "user" ? "<b>Du:</b> " : role === "bot" ? "<b>Bot:</b> " : "⚠️ ") + text;
    els.messages.appendChild(p);
    els.messages.scrollTop = els.messages.scrollHeight;
  }

  async function sendToOpenRouter(prompt) {
    const key = (localStorage.getItem("openrouter_key") || "").trim();
    if (!key) throw new Error("API-Key fehlt");

    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + key,
        "Content-Type": "application/json",
        "X-Title": "WP Pattern Generator"
      },
      body: JSON.stringify({
        model: "xai/grok-4-fast:free", // 👈 kostenloses Modell
        messages: [
          { role: "system", content: "Du erzeugst ausschließlich gültiges Gutenberg-Block-HTML (serialized blocks). Keine Erklärungen, nur den reinen Block-Code. Nur Core-Blöcke." },
          { role: "user", content: prompt }
        ],
        temperature: 0.4
      })
    });

    if (!res.ok) {
      const errText = await res.text().catch(() => String(res.status));
      throw new Error("OpenRouter: " + res.status + " – " + errText);
    }

    const data = await res.json();
    return (data.choices?.[0]?.message?.content || "").trim();
  }

  els.sendBtn.onclick = async () => {
    const userText = els.input.value.trim();
    if (!userText) return;
    addMsg("user", userText);
    els.input.value = "";
    els.sendBtn.disabled = true;

    try {
      const reply = await sendToOpenRouter(userText);
      addMsg("bot", reply || "(keine Antwort)");
      if (!reply.includes("<!-- wp:")) {
        addMsg("error", "Antwort enthält kein Gutenberg-Block-HTML.");
      }
    } catch (err) {
      addMsg("error", err.message);
    } finally {
      els.sendBtn.disabled = false;
    }
  };
  </script>
</body>
</html>
