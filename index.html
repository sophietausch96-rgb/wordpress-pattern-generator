<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WP Playground + OpenRouter Bot (Free Fallbacks)</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <!-- LINKS: WordPress Playground ‚Äì direkt neue Seite im Gutenberg-Editor -->
    <iframe
      class="playground"
      src="https://playground.wordpress.net/?mode=seamless&blueprint-url=./blueprint.json"
      title="WordPress Playground">
    </iframe>

    <!-- RECHTS: Chat -->
    <aside class="chatbox">
      <h2>ü§ñ OpenRouter Bot (Free Modelle)</h2>

      <div class="apikey">
        <input id="apiKeyInput" placeholder="OpenRouter API Key (sk-or-...)" type="password" />
        <button id="saveKeyBtn" type="button">Speichern</button>
      </div>
      <p class="hint">Der API-Key wird nur lokal im Browser (localStorage) gespeichert.</p>

      <div class="model-info" id="modelInfo">Modell: ‚Äì</div>

      <div id="messages" class="messages" aria-live="polite"></div>

      <form id="chatForm" class="input-row" autocomplete="off">
        <input id="chatInput" placeholder="Beschreibe ein Pattern (nur Core-Bl√∂cke) ‚Ä¶" />
        <button id="sendBtn" type="submit">Senden</button>
      </form>
    </aside>
  </div>

  <script>
  // ---------- UI ----------
  const els = {
    keyInput: document.getElementById('apiKeyInput'),
    saveBtn: document.getElementById('saveKeyBtn'),
    form: document.getElementById('chatForm'),
    input: document.getElementById('chatInput'),
    sendBtn: document.getElementById('sendBtn'),
    messages: document.getElementById('messages'),
    modelInfo: document.getElementById('modelInfo')
  };

  try { els.keyInput.value = localStorage.getItem("openrouter_key") || ""; } catch(e) {}

  els.saveBtn.addEventListener('click', () => {
    const val = (els.keyInput.value || "").trim();
    if(!val) { alert("Bitte API-Key eintragen (sk-or-‚Ä¶)"); return; }
    try { localStorage.setItem("openrouter_key", val); alert("API-Key gespeichert!"); }
    catch(e){ alert("Konnte den Key nicht speichern."); }
  });

  function addMsg(role, html){
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + role;
    wrap.innerHTML = html;
    els.messages.appendChild(wrap);
    els.messages.scrollTop = els.messages.scrollHeight;
  }

  function addCopyButton(textToCopy){
    const box = document.createElement('div');
    box.className = 'copy-row';
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = 'In Zwischenablage kopieren';
    btn.onclick = async () => {
      try { await navigator.clipboard.writeText(textToCopy); btn.textContent = 'Kopiert ‚úÖ'; }
      catch(e){ btn.textContent = 'Konnte nicht kopieren'; }
    };
    box.appendChild(btn);
    els.messages.appendChild(box);
    els.messages.scrollTop = els.messages.scrollHeight;
  }

  // ---------- OpenRouter Call mit Fallbacks ----------
  const FREE_MODELS = [
    "deepseek/deepseek-chat-v3-0324:free",
    "deepseek/deepseek-r1:free",
    "mistralai/mistral-7b-instruct:free"
  ];

  const SYSTEM_PROMPT = "Du erzeugst AUSSCHLIESSLICH g√ºltiges Gutenberg-Block-HTML (serialized blocks). " +
    "Keine Erkl√§rungen, kein Markdown, keine Codefences. Nur Core-Bl√∂cke. " +
    "Beginne mit <!-- wp: und schlie√üe alle Bl√∂cke korrekt.";

  function sanitizeLLM(text){
    if(!text) return "";
    // entferne ``` und ```html fences
    return text.replace(/```(?:html)?/gi, "").trim();
  }

  function ensureGutenberg(html){
    const cleaned = sanitizeLLM(html);
    if (cleaned.includes("<!-- wp:")) return cleaned;
    // Fallback: Minimal-Block
    const safe = cleaned ? cleaned.replace(/[<>]/g, s => ({'<':'&lt;','>':'&gt;'}[s])) : "KI-Ausgabe fehlte.";
    return `<!-- wp:paragraph --><p>${safe}</p><!-- /wp:paragraph -->`;
  }

  async function callOpenRouterOnce(model, prompt){
    const key = (localStorage.getItem('openrouter_key') || '').trim();
    if(!key) throw new Error('API-Key fehlt. Bitte rechts oben speichern.');

    const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + key,
        'Content-Type': 'application/json',
        'X-Title': 'WP Pattern Generator'
      },
      body: JSON.stringify({
        model,
        messages: [
          { role: 'system', content: SYSTEM_PROMPT },
          { role: 'user', content: prompt }
        ],
        temperature: 0.3,
        max_tokens: 1200,
        top_p: 0.9
      })
    });

    if(!res.ok){
      const txt = await res.text().catch(()=>String(res.status));
      throw new Error(`OpenRouter: ${res.status} ‚Äì ${txt}`);
    }
    const data = await res.json();
    const raw = (data.choices?.[0]?.message?.content || "").trim();
    return sanitizeLLM(raw);
  }

  async function callWithFallbacks(prompt){
    let lastErr = null;
    for(const model of FREE_MODELS){
      els.modelInfo.textContent = "Modell: " + model;
      try {
        const out = await callOpenRouterOnce(model, prompt);
        if (out) return { model, out };
      } catch(e){
        lastErr = e; // n√§chstes Modell probieren
      }
    }
    throw lastErr || new Error("Keine Antwort erhalten.");
  }

  // ---------- Form-Handler ----------
  els.form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const userText = els.input.value.trim();
    if(!userText) return;

    // Prompt-Template (macht die Ausgabe robuster)
    const prompt = "Erzeuge ein responsives Gutenberg-Layout. Nutze NUR Core-Bl√∂cke. " +
      "Gib NUR serialized Gutenberg-Block-HTML zur√ºck ‚Äì keine Erkl√§rungen, kein Markdown. " +
      "Wunsch: " + userText;

    addMsg('user', `<b>Du:</b> ${userText}`);
    els.input.value = '';
    els.sendBtn.disabled = true;

    try {
      const { model, out } = await callWithFallbacks(prompt);
      const html = ensureGutenberg(out);
      addMsg('bot', `<b>Bot (${model}):</b><pre class="code">${html.replace(/</g,"&lt;")}</pre>`);
      addCopyButton(html);
      if (!out.includes('<!-- wp:')) {
        addMsg('warn', '‚ö†Ô∏è Die Antwort war nicht als Gutenberg-HTML formatiert ‚Äì es wurde ein Paragraph-Block als Fallback gebaut.');
      }
    } catch(err){
      addMsg('error', err.message);
    } finally {
      els.sendBtn.disabled = false;
    }
  });
  </script>
</body>
</html>
