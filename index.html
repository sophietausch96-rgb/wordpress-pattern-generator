<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WP Playground + Bot</title>
  <link rel="stylesheet" href="./style.css" />
  <!-- Code-Highlighting (dunkles Theme) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs/themes/prism-tomorrow.min.css">
</head>
<body>
  <div class="container">
    <!-- LINKS: Playground l√§dt Blueprint und √∂ffnet den Seiten-Editor -->
    <iframe
      class="playground"
      id="wpFrame"
      src="https://playground.wordpress.net/?mode=seamless&blueprint-url=./blueprint.json"
      title="WordPress Playground">
    </iframe>

    <!-- RECHTS: Bot -->
    <aside class="chatbox chatbox--dark">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="chat">üí¨ Chat</button>
        <button class="tab" data-tab="settings">‚öôÔ∏è Einstellungen</button>
      </div>

      <!-- CHAT -->
      <div class="tabcontent active" id="tab-chat">
        <div class="model-info" id="modelInfo">Modell: ‚Äì</div>

        <div id="messages" class="messages"></div>

        <!-- Spinner -->
        <div id="spinner" class="spinner" aria-hidden="true">
          <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>

        <form id="chatForm" class="input-row" autocomplete="off">
          <input id="chatInput" placeholder="Beschreibe ein Pattern ‚Ä¶ (nur Core-Bl√∂cke)" />
          <button id="sendBtn" type="submit">Senden</button>
        </form>
      </div>

      <!-- EINSTELLUNGEN -->
      <div class="tabcontent" id="tab-settings">
        <h3>API-Key speichern</h3>
        <input id="apiKeyInput" type="password" placeholder="OpenRouter API Key (sk-or-‚Ä¶)" />
        <button id="saveKeyBtn" type="button">Speichern</button>
        <p class="hint">Der API-Key wird nur lokal im Browser (localStorage) gespeichert.</p>
      </div>
    </aside>
  </div>

  <!-- Prism f√ºrs Code-Highlighting -->
  <script src="https://cdn.jsdelivr.net/npm/prismjs/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-markup.min.js"></script>

  <script>
  // ---------- Tabs ----------
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tabcontent').forEach(tc=>tc.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-'+btn.dataset.tab).classList.add('active');
    });
  });

  // ---------- UI refs ----------
  const els = {
    keyInput: document.getElementById('apiKeyInput'),
    saveBtn: document.getElementById('saveKeyBtn'),
    form: document.getElementById('chatForm'),
    input: document.getElementById('chatInput'),
    sendBtn: document.getElementById('sendBtn'),
    messages: document.getElementById('messages'),
    modelInfo: document.getElementById('modelInfo'),
    frame: document.getElementById('wpFrame'),
    spinner: document.getElementById('spinner')
  };

  // Key laden/speichern
  try { els.keyInput.value = localStorage.getItem("openrouter_key") || ""; } catch(e) {}
  els.saveBtn.addEventListener('click', () => {
    const val = (els.keyInput.value || "").trim();
    if(!val){ alert("Bitte API-Key eintragen (sk-or-‚Ä¶)"); return; }
    try { localStorage.setItem("openrouter_key", val); alert("API-Key gespeichert!"); }
    catch(e){ alert("Speichern fehlgeschlagen."); }
  });

  // Nachrichten-Helfer
  function addMsg(role, html){
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + role;
    wrap.innerHTML = html;
    els.messages.appendChild(wrap);
    els.messages.scrollTop = els.messages.scrollHeight;
  }

  function addCodeBlock(model, html){
    const pre = document.createElement('pre');
    const code = document.createElement('code');
    pre.className = 'code language-markup'; // Prism: markup
    code.className = 'language-markup';
    code.textContent = html; // Prism highlightet danach
    pre.appendChild(code);
    const wrap = document.createElement('div');
    wrap.className = 'msg bot';
    wrap.innerHTML = `<b>Bot (${model}):</b>`;
    wrap.appendChild(pre);
    els.messages.appendChild(wrap);
    Prism.highlightElement(code);
    els.messages.scrollTop = els.messages.scrollHeight;
  }

  function setLoading(isLoading){
    els.spinner.setAttribute('aria-hidden', isLoading ? 'false' : 'true');
    els.spinner.style.display = isLoading ? 'flex' : 'none';
    els.sendBtn.disabled = isLoading;
  }

  // ---------- Modelle (Fallbacks) ----------
  const FREE_MODELS = [
    "deepseek/deepseek-chat-v3-0324:free",
    "deepseek/deepseek-r1:free",
    "mistralai/mistral-7b-instruct:free"
  ];

  const SYSTEM_PROMPT =
    "Du erzeugst AUSSCHLIESSLICH g√ºltiges Gutenberg-Block-HTML (serialized blocks). " +
    "Keine Erkl√§rungen, kein Markdown, keine Codefences. Nur Core-Bl√∂cke. " +
    "Beginne mit <!-- wp: und schlie√üe alle Bl√∂cke korrekt.";

  function sanitize(text){ return (text||"").replace(/```(?:html)?/gi,"").trim(); }

  function ensureGutenberg(html){
    const cleaned = sanitize(html);
    if (cleaned.includes("<!-- wp:")) return cleaned;
    // Fallback: minimaler Absatz (damit immer etwas registriert wird)
    const safe = cleaned || "Leere Antwort";
    return `<!-- wp:paragraph --><p>${safe.replace(/[<>]/g, s => ({'<':'&lt;','>':'&gt;'}[s]))}</p><!-- /wp:paragraph -->`;
  }

  async function callOpenRouterOnce(model, prompt){
    const key = (localStorage.getItem('openrouter_key')||'').trim();
    if(!key) throw new Error("API-Key fehlt");
    const res = await fetch("https://openrouter.ai/api/v1/chat/completions",{
      method:"POST",
      headers:{
        "Authorization":"Bearer "+key,
        "Content-Type":"application/json",
        "X-Title":"WP Pattern Generator"
      },
      body:JSON.stringify({
        model,
        messages:[
          {role:"system",content:SYSTEM_PROMPT},
          {role:"user",content:prompt}
        ],
        temperature:0.3,
        max_tokens:1200
      })
    });
    if(!res.ok){
      const txt = await res.text().catch(()=>String(res.status));
      throw new Error(`OpenRouter: ${res.status} ‚Äì ${txt}`);
    }
    const data=await res.json();
    return sanitize(data.choices?.[0]?.message?.content||"");
  }

  async function callWithFallbacks(prompt){
    let lastErr = null;
    for(const m of FREE_MODELS){
      els.modelInfo.textContent = "Modell: " + m;
      try {
        const out = await callOpenRouterOnce(m,prompt);
        if (out) return {model:m,out};
      } catch(e){ lastErr = e; }
    }
    throw lastErr || new Error("Keine Antwort von freien Modellen.");
  }

  // ---------- WP Playground: Pattern per REST registrieren ----------
  // Der Playground-iframe versteht postMessage-Events und ruft WP intern auf.
  function sendPatternToWP(html){
    els.frame.contentWindow.postMessage({
      type: "REST_API_REQUEST",
      path: "/wp-json/ai-patterns/v1/create",
      method: "POST",
      body: { title: "AI Pattern", content: html }
    }, "*");
  }

  // ---------- Chat Submit ----------
  els.form.addEventListener('submit', async e=>{
    e.preventDefault();
    const userText = els.input.value.trim();
    if(!userText) return;
    addMsg("user","<b>Du:</b> "+userText);
    els.input.value="";

    setLoading(true);
    try{
      const prompt = "Erzeuge ein responsives Gutenberg-Pattern. Nutze NUR Core-Bl√∂cke. " +
        "Gib NUR serialized Gutenberg-Block-HTML zur√ºck ‚Äì keine Erkl√§rungen. Wunsch: " + userText;

      const {model, out} = await callWithFallbacks(prompt);
      const html = ensureGutenberg(out);

      addCodeBlock(model, html);       // h√ºbsch gef√§rbter Codeblock
      sendPatternToWP(html);           // automatisch im WP-Playground registrieren
      addMsg("info","‚úÖ Pattern automatisch importiert (Inserter ‚Üí <b>AI Patterns</b>).");
    }catch(err){
      addMsg("error", err.message);
    }finally{
      setLoading(false);
    }
  });
  </script>
</body>
</html>
