<!-- /index.html -->
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WP Playground + Bot (Auto-Pattern)</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div class="container">
    <!-- LINKS: Gutenberg-Editor (neue Seite) -->
    <iframe
      class="playground"
      id="wpFrame"
      src="https://playground.wordpress.net/?mode=seamless&blueprint-url=./blueprint.json&start_url=%2Fwp-admin%2Fpost-new.php%3Fpost_type%3Dpage"
      title="WordPress Playground">
    </iframe>

    <!-- RECHTS: Bot -->
    <aside class="chatbox">
      <div class="tabs">
        <button class="tab active" data-tab="chat">üí¨ Chat</button>
        <button class="tab" data-tab="settings">‚öôÔ∏è Einstellungen</button>
      </div>

      <div class="tabcontent active" id="tab-chat">
        <div class="model-row">
          <span class="model-info" id="modelInfo">Modell: ‚Äì</span>
          <span class="spinner" id="spinner" aria-hidden="true"></span>
        </div>

        <div id="messages" class="messages"></div>

        <form id="chatForm" class="input-row" autocomplete="off">
          <input id="chatInput" placeholder="Beschreibe ein Pattern ‚Ä¶ (nur Core-Bl√∂cke, NUR HTML ausgeben)" />
          <button id="sendBtn" type="submit">Senden</button>
        </form>
      </div>

      <div class="tabcontent" id="tab-settings">
        <h3>API-Key</h3>
        <input id="apiKeyInput" type="password" placeholder="OpenRouter API Key (sk-or-‚Ä¶)" />
        <button id="saveKeyBtn" type="button">Speichern</button>
        <p class="hint">Der Key wird nur lokal im Browser (localStorage) gespeichert.</p>
      </div>
    </aside>
  </div>

  <script>
  /* Tabs */
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tabcontent').forEach(tc=>tc.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-'+btn.dataset.tab).classList.add('active');
    });
  });

  /* Refs */
  const els = {
    frame: document.getElementById('wpFrame'),
    keyInput: document.getElementById('apiKeyInput'),
    saveBtn: document.getElementById('saveKeyBtn'),
    modelInfo: document.getElementById('modelInfo'),
    spinner: document.getElementById('spinner'),
    messages: document.getElementById('messages'),
    form: document.getElementById('chatForm'),
    input: document.getElementById('chatInput'),
    sendBtn: document.getElementById('sendBtn')
  };

  try { els.keyInput.value = localStorage.getItem("openrouter_key") || ""; } catch(e) {}

  els.saveBtn.addEventListener('click', () => {
    const val = (els.keyInput.value || "").trim();
    if(!val){ alert("Bitte API-Key eintragen (sk-or-‚Ä¶)"); return; }
    try { localStorage.setItem("openrouter_key", val); alert("API-Key gespeichert!"); }
    catch(e){ alert("Speichern fehlgeschlagen."); }
  });

  function setLoading(state){
    els.sendBtn.disabled = !!state;
    els.spinner.classList.toggle('on', !!state);
  }

  function addMsg(role, html){
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + role;
    wrap.innerHTML = html;
    els.messages.appendChild(wrap);
    els.messages.scrollTop = els.messages.scrollHeight;
  }

  /* Mini Syntax Highlight */
  function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function highlightGutenberg(raw){
    const s = escapeHtml(raw);
    return s
      .replace(/&lt;!--\s*\/?wp:[\s\S]*?--&gt;/g, m => `<span class="tok-comment">${m}</span>`)
      .replace(/(&lt;\/?)([a-zA-Z0-9:-]+)([^&]*?)(\/?&gt;)/g, (_m, p1, name, attrs, p4) =>
        `${p1}<span class="tok-tag">${name}</span>${attrs.replace(/([a-zA-Z-:]+)=(&quot;.*?&quot;)/g,'<span class="tok-attr">$1</span>=<span class="tok-val">$2</span>')}${p4}`
      );
  }

  /* OpenRouter */
  const FREE_MODELS = [
    "mistralai/mistral-7b-instruct:free",
    "deepseek/deepseek-chat-v3-0324:free"
  ];
  const SYSTEM_PROMPT =
    "Du erzeugst AUSSCHLIESSLICH g√ºltiges Gutenberg-Block-HTML (serialized blocks). "+
    "Keine Erkl√§rungen, kein Markdown, keine Codefences. Nur Core-Bl√∂cke. "+
    "Beginne mit <!-- wp: und schlie√üe alle Bl√∂cke korrekt.";

  function sanitize(text){ return (text||"").replace(/```(?:html)?/gi,"").trim(); }

  function ensureGutenberg(html){
    const cleaned = sanitize(html);
    if (cleaned.includes("<!-- wp:")) return cleaned;
    const safe = cleaned ? escapeHtml(cleaned) : "Leere Antwort";
    return `<!-- wp:paragraph --><p>${safe}</p><!-- /wp:paragraph -->`;
  }

  async function callOpenRouterOnce(model, prompt){
    const key = (localStorage.getItem('openrouter_key')||'').trim();
    if(!key) throw new Error("API-Key fehlt");
    const res = await fetch("https://openrouter.ai/api/v1/chat/completions",{
      method:"POST",
      headers:{
        "Authorization":"Bearer "+key,
        "Content-Type":"application/json",
        "X-Title":"WP Pattern Generator"
      },
      body:JSON.stringify({
        model,
        messages:[
          {role:"system", content: SYSTEM_PROMPT},
          {role:"user", content: prompt}
        ],
        temperature: 0.2,
        max_tokens: 1200,
        stop: ["```","</html>"] // verhindert Ausschweifungen
      })
    });
    if(!res.ok){
      const t = await res.text().catch(()=>String(res.status));
      throw new Error("OpenRouter: "+res.status+" ‚Äì "+t);
    }
    const data = await res.json();
    return sanitize(data.choices?.[0]?.message?.content || "");
  }

  async function callWithFallbacks(prompt){
    let lastErr;
    for(const m of FREE_MODELS){
      els.modelInfo.textContent = "Modell: " + m;
      try {
        const out = await callOpenRouterOnce(m, prompt);
        if(out) return { model: m, out };
      } catch(e){ lastErr = e; }
    }
    throw lastErr || new Error("Keine Antwort");
  }

  /* WP Playground Bridge */
  function sendPatternToWP(html){
    return new Promise((resolve) => {
      // 1) Prim√§r: Plugin-Bridge (passt sicher zum PHP-Listener)
      els.frame.contentWindow.postMessage({
        type: "AI_PATTERNS_CREATE",
        payload: { title: "AI Pattern", content: html }
      }, "*");

      // 2) Optionaler Fallback: Playground REST Proxy (wenn vorhanden)
      const reqId = 'req_' + Math.random().toString(36).slice(2);
      const onMsg = (ev)=>{
        const d = ev.data || {};
        if(d && d.type === 'REST_API_RESPONSE' && d.id === reqId){
          window.removeEventListener('message', onMsg);
          resolve(d.ok);
        }
      };
      window.addEventListener('message', onMsg);
      els.frame.contentWindow.postMessage({
        type: "REST_API_REQUEST",
        id: reqId,
        path: "/wp-json/ai-patterns/v1/create",
        method: "POST",
        body: { title: "AI Pattern", content: html }
      }, "*");

      // 3) Safety: auch ohne Response weitermachen (Playground antwortet nicht immer)
      setTimeout(()=>{ window.removeEventListener('message', onMsg); resolve(true); }, 3000);
    });
  }

  /* Submit */
  els.form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const userText = els.input.value.trim();
    if(!userText) return;

    const prompt =
      "Erzeuge ein responsives Gutenberg-Pattern. Nutze NUR Core-Bl√∂cke. "+
      "Gib NUR serialized Gutenberg-Block-HTML zur√ºck. "+
      "Wunsch: " + userText;

    addMsg('user', `<b>Du:</b> ${userText}`);
    els.input.value = '';
    setLoading(true);

    try {
      const { model, out } = await callWithFallbacks(prompt);
      const html = ensureGutenberg(out);
      const pretty = highlightGutenberg(html);
      addMsg('bot', `<b>Bot (${model}):</b><pre class="code">${pretty}</pre>`);

      await sendPatternToWP(html);
      addMsg('info', '‚úÖ Pattern registriert. √ñffne im Editor den Block-Inserter ‚Üí ‚ÄûAI Patterns‚Äú und f√ºge es ein.');

    } catch(err){
      addMsg('error', '‚ùå '+(err?.message||String(err)));
    } finally {
      setLoading(false);
    }
  });
  </script>
</body>
</html>
